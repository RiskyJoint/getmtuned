<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuneMySubaru | Precision Performance Engineering</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Michroma&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Luxury Performance Color Palette */
            --carbon-black: #0a0a0a;
            --midnight: #121212;
            --dark-chrome: #1a1a1a;
            --gunmetal: #2d2d2d;
            --titanium: #3e3e3e;
            --racing-red: #dc2626;
            --racing-red-glow: #ef4444;
            --championship-gold: #fbbf24;
            --gold-accent: #f59e0b;
            --platinum: #e5e5e5;
            --silver: #a3a3a3;
            --oil-slick: linear-gradient(45deg, #dc2626, #7c3aed, #0891b2, #dc2626);
            
            /* Functional Colors */
            --boost-blue: #0ea5e9;
            --torque-orange: #fb923c;
            --afr-purple: #a855f7;
            --success-green: #22c55e;
            --warning-amber: #f59e0b;
            --danger-red: #ef4444;
        }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--carbon-black);
            color: var(--platinum);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Premium Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(220, 38, 38, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(251, 191, 36, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(14, 165, 233, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Carbon Fiber Pattern Overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.03;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,.1) 2px, rgba(255,255,255,.1) 4px),
                repeating-linear-gradient(-45deg, transparent, transparent 2px, rgba(255,255,255,.05) 2px, rgba(255,255,255,.05) 4px);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Navigation - Luxury Header */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(10, 10, 10, 0.98), rgba(10, 10, 10, 0.9));
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        nav::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--championship-gold), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            text-decoration: none;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--championship-gold), var(--racing-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            position: relative;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--oil-slick);
            background-size: 200% 100%;
            animation: slideGradient 3s linear infinite;
        }
        
        @keyframes slideGradient {
            to { background-position: -200% 0; }
        }
        
        .nav-links {
            display: flex;
            gap: 3rem;
            align-items: center;
        }
        
        .nav-link {
            color: var(--silver);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--racing-red);
            transition: width 0.3s ease;
        }
        
        .nav-link:hover {
            color: var(--championship-gold);
        }
        
        .nav-link:hover::before {
            width: 100%;
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            padding-top: 120px;
            position: relative;
            z-index: 2;
        }
        
        /* Hero Section - Luxury Performance */
        .hero {
            padding: 5rem 0 3rem;
            text-align: center;
            position: relative;
        }
        
        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.875rem;
            color: var(--championship-gold);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }
        
        .hero-badge::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.3), transparent);
            animation: sweep 3s infinite;
        }
        
        @keyframes sweep {
            to { left: 100%; }
        }
        
        .hero-title {
            font-family: 'Michroma', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 400;
            line-height: 1.1;
            margin-bottom: 2rem;
            letter-spacing: -1px;
            position: relative;
        }
        
        .hero-title .accent {
            background: linear-gradient(135deg, var(--championship-gold), var(--racing-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hero-subtitle {
            font-size: 1.5rem;
            color: var(--silver);
            max-width: 700px;
            margin: 0 auto 3rem;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        /* Premium Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2px;
            background: rgba(251, 191, 36, 0.1);
            padding: 2px;
            border-radius: 20px;
            margin-bottom: 4rem;
            position: relative;
            overflow: hidden;
        }
        
        .stats-bar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(251, 191, 36, 0.1) 50%, transparent 70%);
            animation: shine 4s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) skewX(-45deg); }
            100% { transform: translateX(200%) skewX(-45deg); }
        }
        
        .stat {
            background: var(--midnight);
            padding: 2.5rem 2rem;
            text-align: center;
            border-radius: 18px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat:hover {
            background: var(--dark-chrome);
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--championship-gold), var(--gold-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }
        
        .stat-label {
            color: var(--silver);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        
        /* Upload Section - Premium Feel */
        .upload-section {
            background: linear-gradient(135deg, var(--midnight), var(--dark-chrome));
            border: 1px solid rgba(251, 191, 36, 0.1);
            border-radius: 30px;
            padding: 4rem;
            margin-bottom: 4rem;
            position: relative;
            overflow: hidden;
        }
        
        .upload-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            z-index: 1;
        }
        
        .section-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .section-subtitle {
            color: var(--silver);
            font-size: 1.125rem;
        }
        
        /* Premium Upload Area */
        .upload-area {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05), rgba(251, 191, 36, 0.05));
            border: 2px dashed rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            padding: 5rem 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .upload-area:hover {
            border-color: var(--championship-gold);
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(251, 191, 36, 0.1));
            transform: scale(1.01);
        }
        
        .upload-area.dragover {
            border-color: var(--racing-red);
            background: rgba(220, 38, 38, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem;
            background: linear-gradient(135deg, var(--racing-red), var(--championship-gold));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.3);
        }
        
        .upload-icon::after {
            content: '';
            position: absolute;
            inset: -10px;
            background: linear-gradient(135deg, var(--racing-red), var(--championship-gold));
            border-radius: 50%;
            opacity: 0.3;
            filter: blur(20px);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }
        
        .upload-text {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .upload-subtext {
            color: var(--silver);
            font-size: 1rem;
        }
        
        .file-info {
            margin-top: 1.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            color: var(--success-green);
            font-weight: 600;
            display: inline-block;
        }
        
        /* Configuration Form - Luxury Inputs */
        .config-section {
            margin-top: 3rem;
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .config-section.show {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .form-group {
            background: linear-gradient(135deg, var(--dark-chrome), var(--midnight));
            border: 1px solid rgba(251, 191, 36, 0.1);
            border-radius: 15px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .form-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--championship-gold), transparent);
            transition: left 0.5s ease;
        }
        
        .form-group:hover::before {
            left: 100%;
        }
        
        .form-group:hover {
            border-color: rgba(251, 191, 36, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.1);
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--championship-gold);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--carbon-black);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 10px;
            color: var(--platinum);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Rajdhani', sans-serif;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--championship-gold);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
            background: var(--midnight);
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        /* SAE Correction Controls */
        .sae-controls {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.05), rgba(14, 165, 233, 0.02));
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .sae-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .sae-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--boost-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--gunmetal);
            border-radius: 30px;
            transition: all 0.3s ease;
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: var(--silver);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--boost-blue), var(--racing-red));
        }
        
        input:checked + .toggle-slider::before {
            transform: translateX(30px);
            background: white;
        }
        
        /* Analyze Button - Premium CTA */
        .analyze-section {
            text-align: center;
            margin-top: 3rem;
        }
        
        .btn {
            padding: 1.25rem 4rem;
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--racing-red), var(--championship-gold));
            color: white;
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Loading Overlay - Premium */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            text-align: center;
            position: relative;
        }
        
        .spinner {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(251, 191, 36, 0.1);
            border-top-color: var(--championship-gold);
            border-right-color: var(--racing-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            color: var(--platinum);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 2rem;
        }
        
        .loading-steps {
            text-align: left;
            display: inline-block;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.75rem 0;
            color: var(--silver);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .loading-step.active {
            color: var(--championship-gold);
            transform: translateX(10px);
        }
        
        .loading-step.complete {
            color: var(--success-green);
        }
        
        .loading-step.complete::before {
            content: '✓';
            color: var(--success-green);
        }
        
        /* Results Section - Premium Display */
        .results-section {
            display: none;
            margin-top: 4rem;
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 4rem;
        }
        
        .power-gain {
            font-family: 'Orbitron', monospace;
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--success-green), var(--championship-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 1.5rem 0;
            letter-spacing: -2px;
        }
        
        /* Dyno Chart Container - Premium */
        .dyno-container {
            background: linear-gradient(135deg, var(--midnight), var(--dark-chrome));
            border: 1px solid rgba(251, 191, 36, 0.1);
            border-radius: 25px;
            padding: 3rem;
            margin-bottom: 4rem;
            position: relative;
            overflow: hidden;
        }
        
        .dyno-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(220, 38, 38, 0.05) 0%, transparent 70%);
            animation: rotate 30s linear infinite reverse;
        }
        
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .chart-controls label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--silver);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .chart-controls label:hover {
            color: var(--platinum);
        }
        
        .chart-controls input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--championship-gold);
        }
        
        .chart-controls select {
            background: var(--dark-chrome);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 8px;
            color: var(--platinum);
            padding: 0.5rem 1rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }
        
        #dynoChart {
            width: 100%;
            height: 600px;
            position: relative;
            z-index: 1;
            background: var(--carbon-black);
            border-radius: 15px;
            padding: 20px;
        }
        
        /* Analysis Cards - Premium */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 4rem;
        }
        
        .analysis-card {
            background: linear-gradient(135deg, var(--midnight), var(--dark-chrome));
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            transition: all 0.3s ease;
        }
        
        .analysis-card.good::before {
            background: var(--success-green);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        .analysis-card.warning::before {
            background: var(--warning-amber);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }
        
        .analysis-card.danger::before {
            background: var(--danger-red);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .analysis-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .analysis-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .analysis-card.good .analysis-icon {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success-green);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        
        .analysis-card.warning .analysis-icon {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-amber);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }
        
        .analysis-card.danger .analysis-icon {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-red);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }
        
        .analysis-value {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 1rem 0;
            letter-spacing: -1px;
        }
        
        .analysis-description {
            color: var(--silver);
            font-size: 1rem;
            line-height: 1.6;
        }
        
        /* CTA Section - Luxury */
        .cta-section {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05), rgba(251, 191, 36, 0.05));
            border: 2px solid rgba(251, 191, 36, 0.2);
            border-radius: 30px;
            padding: 4rem;
            text-align: center;
            margin-top: 4rem;
            position: relative;
            overflow: hidden;
        }
        
        .cta-section::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        .cta-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        .cta-subtitle {
            color: var(--silver);
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
            position: relative;
            z-index: 1;
        }
        
        .cta-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--championship-gold);
            border: 2px solid var(--championship-gold);
            padding: 1.25rem 3rem;
            font-size: 1.125rem;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--championship-gold);
            color: var(--carbon-black);
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3);
        }
        
        /* Baseline Request Message */
        .baseline-message {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: center;
            color: var(--warning-amber);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        
        .baseline-message button {
            margin-top: 1rem;
            background: var(--warning-amber);
            color: var(--carbon-black);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .baseline-message button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* Footer - Minimal Luxury */
        footer {
            margin-top: 8rem;
            padding: 3rem 0;
            border-top: 1px solid rgba(251, 191, 36, 0.1);
            text-align: center;
            color: var(--silver);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 2;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                gap: 1.5rem;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .cta-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="#" class="logo">TUNEMYSUBARU</a>
            <div class="nav-links">
                <a href="#" class="nav-link">Performance</a>
                <a href="#" class="nav-link">Technology</a>
                <a href="#" class="nav-link">Heritage</a>
                <a href="portal.html" class="nav-link">Portal</a>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container">
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-badge">
                <span>🏁</span> Cobb Protuner Since 2008
            </div>
            <h1 class="hero-title">
                Virtual Dyno <span class="accent">Perfected</span>
            </h1>
            <p class="hero-subtitle">
                Upload your datalog. Get laboratory-grade power analysis. 
                Experience the future of remote tuning.
            </p>
        </section>
        
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value">±2%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat">
                <div class="stat-value">15K+</div>
                <div class="stat-label">Dynos Run</div>
            </div>
            <div class="stat">
                <div class="stat-value">50Hz</div>
                <div class="stat-label">Processing</div>
            </div>
            <div class="stat">
                <div class="stat-value">24/7</div>
                <div class="stat-label">Analysis</div>
            </div>
        </div>
        
        <!-- Upload Section -->
        <section class="upload-section">
            <div class="section-header">
                <h2 class="section-title">Upload Datalog</h2>
                <p class="section-subtitle">CSV format from Cobb Accessport</p>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📊</div>
                <div class="upload-text">Drop Your Log Here</div>
                <div class="upload-subtext">or click to select file</div>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
            </div>
            
            <!-- Configuration Form -->
            <div class="config-section" id="configSection">
                <!-- SAE Correction Controls -->
                <div class="sae-controls">
                    <div class="sae-header">
                        <div class="sae-title">SAE J1349 Correction</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="saeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-grid" id="saeInputs" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="form-group">
                            <label class="form-label">Ambient Temperature</label>
                            <input type="number" class="form-input" id="ambientTemp" placeholder="77°F" value="77">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Barometric Pressure</label>
                            <input type="number" class="form-input" id="baroPressure" placeholder="29.92 inHg" value="29.92" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Elevation (ft)</label>
                            <input type="number" class="form-input" id="elevation" placeholder="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Humidity (%)</label>
                            <input type="number" class="form-input" id="humidity" placeholder="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Vehicle Model</label>
                        <select class="form-input" id="vehicle">
                            <option value="">Select your Subaru</option>
                            <option value="2022-wrx">2022+ WRX (VB)</option>
                            <option value="2015-2021-wrx">2015-2021 WRX (VA)</option>
                            <option value="2015-2021-sti">2015-2021 STI (VA)</option>
                            <option value="2008-2014-wrx">2008-2014 WRX (GR/GV)</option>
                            <option value="2004-2007-sti">2004-2007 STI (GD)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Modification Stage</label>
                        <select class="form-input" id="modLevel">
                            <option value="">Select your stage</option>
                            <option value="stock">Stock</option>
                            <option value="stage1">Stage 1</option>
                            <option value="stage2">Stage 2</option>
                            <option value="stage2plus">Stage 2+</option>
                            <option value="flex">Flex Fuel</option>
                            <option value="bigturbo">Big Turbo</option>
                            <option value="built">Built Motor</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fuel Grade</label>
                        <select class="form-input" id="fuel">
                            <option value="">Select fuel</option>
                            <option value="91">91 Octane</option>
                            <option value="93">93 Octane</option>
                            <option value="e30">E30 Blend</option>
                            <option value="e50">E50 Blend</option>
                            <option value="e85">E85</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tune Aggressiveness</label>
                        <select class="form-input" id="safety">
                            <option value="">Select preference</option>
                            <option value="conservative">Conservative</option>
                            <option value="moderate">Moderate</option>
                            <option value="aggressive">Aggressive</option>
                            <option value="yolo">Maximum Attack</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Base Weight (lbs)</label>
                        <input type="number" class="form-input" id="weight" placeholder="3500" value="3500">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Driver Weight (lbs)</label>
                        <input type="number" class="form-input" id="driverWeight" placeholder="180" value="180">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Passengers</label>
                        <select class="form-input" id="passengers">
                            <option value="0">None</option>
                            <option value="1">1 Passenger</option>
                            <option value="2">2 Passengers</option>
                            <option value="3">3 Passengers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Dyno Gear</label>
                        <select class="form-input" id="selectedGear">
                            <option value="3">3rd Gear</option>
                            <option value="4">4th Gear</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tire Size</label>
                        <input type="text" class="form-input" id="tireSize" placeholder="245/40R18" value="245/40R18">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Transmission</label>
                        <select class="form-input" id="transmission">
                            <option value="manual">Manual</option>
                            <option value="cvt">CVT</option>
                        </select>
                    </div>
                </div>
                
                <div class="analyze-section">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>
                        Initiate Analysis
                    </button>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing Performance</div>
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <span>○</span> Parsing datalog structure
                </div>
                <div class="loading-step" id="step2">
                    <span>○</span> Detecting pull sequences
                </div>
                <div class="loading-step" id="step3">
                    <span>○</span> Calculating physics model
                </div>
                <div class="loading-step" id="step4">
                    <span>○</span> Applying SAE corrections
                </div>
                <div class="loading-step" id="step5">
                    <span>○</span> Generating dyno curves
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Section -->
    <div class="container">
        <section class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 class="section-title">Performance Analysis</h2>
                <div class="power-gain">+<span id="powerGainValue">0</span> WHP</div>
                <p class="section-subtitle">Potential gains with M-TUNED calibration</p>
            </div>
            
            <!-- Dyno Chart -->
            <div class="dyno-container">
                <div class="chart-controls">
                    <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
                        <label>
                            <input type="checkbox" id="showPower" checked>
                            <span style="color: var(--success-green);">Power</span>
                        </label>
                        <label>
                            <input type="checkbox" id="showTorque">
                            <span style="color: var(--torque-orange);">Torque</span>
                        </label>
                        <label>
                            <input type="checkbox" id="showBoost">
                            <span style="color: var(--boost-blue);">Boost</span>
                        </label>
                        <label>
                            <input type="checkbox" id="showAFR">
                            <span style="color: var(--afr-purple);">AFR</span>
                        </label>
                        <label>
                            <input type="checkbox" id="showSlip">
                            <span style="color: var(--warning-amber);">Slip %</span>
                        </label>
                        <label style="margin-left: 2rem; padding-left: 2rem; border-left: 1px solid rgba(255,255,255,0.1);">
                            <input type="checkbox" id="hideBaseline">
                            <span>Hide Baseline</span>
                        </label>
                        <label style="border-left: 1px solid rgba(255,255,255,0.1); padding-left: 2rem;">
                            <input type="checkbox" id="dynojetMode">
                            <span>Dynojet Mode</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            Smoothing:
                            <select id="smoothingLevel">
                                <option value="0">Off (Raw)</option>
                                <option value="1">Minimal</option>
                                <option value="2">Light</option>
                                <option value="3" selected>Standard</option>
                                <option value="4">Heavy</option>
                                <option value="5">Maximum</option>
                            </select>
                        </label>
                    </div>
                </div>
                <div id="dynoChart"></div>
            </div>
            
            <!-- Analysis Cards -->
            <div class="analysis-grid">
                <div class="analysis-card good">
                    <div class="analysis-title">
                        <div class="analysis-icon">✓</div>
                        Peak Performance
                    </div>
                    <div class="analysis-value"><span id="currentPower">0</span> WHP</div>
                    <div class="analysis-description">
                        Current output. M-TUNED potential: <span id="potentialPower">0</span> WHP
                    </div>
                </div>
                
                <div class="analysis-card warning">
                    <div class="analysis-title">
                        <div class="analysis-icon">⚡</div>
                        Boost Pressure
                    </div>
                    <div class="analysis-value"><span id="boostValue">0</span> PSI</div>
                    <div class="analysis-description">
                        Peak boost. Safe limit: <span id="boostPotential">0</span> PSI
                    </div>
                </div>
                
                <div class="analysis-card good">
                    <div class="analysis-title">
                        <div class="analysis-icon">⛽</div>
                        Fuel System
                    </div>
                    <div class="analysis-value"><span id="fuelTrimValue">0</span>%</div>
                    <div class="analysis-description">
                        Fuel trim adaptation within specifications
                    </div>
                </div>
                
                <div class="analysis-card danger" id="knockCard" style="display: none;">
                    <div class="analysis-title">
                        <div class="analysis-icon">⚠</div>
                        Knock Detection
                    </div>
                    <div class="analysis-value"><span id="knockValue">0</span>°</div>
                    <div class="analysis-description">
                        Timing pulled for safety. Tuning required.
                    </div>
                </div>
                
                <div class="analysis-card warning" id="slipCard" style="display: none;">
                    <div class="analysis-title">
                        <div class="analysis-icon">⚡</div>
                        Slip Detection
                    </div>
                    <div class="analysis-value"><span id="slipValue">0</span>%</div>
                    <div class="analysis-description">
                        <span id="slipDescription">Clutch slip detected during pull</span>
                    </div>
                </div>
            </div>
            
            <!-- CTA Section -->
            <div class="cta-section">
                <h3 class="cta-title">Unlock Your Potential</h3>
                <p class="cta-subtitle">Experience precision tuning engineered for your Subaru</p>
                <div class="cta-buttons">
                    <a href="portal.html" class="btn btn-primary">Get M-TUNED</a>
                    <button class="btn btn-secondary" id="downloadReportBtn">Download Report</button>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Footer -->
    <footer>
        <p>© 2024 M-TUNED Performance Engineering. Excellence in Motion.</p>
    </footer>
    
    <script>
        // ===== CSV PARSER =====
        class CSVParser {
            static parse(text) {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
                
                return { headers, data };
            }
        }
        
        // ===== BUTTERWORTH FILTER =====
        class ButterworthFilter {
            constructor(order, cutoffFreq, sampleRate) {
                this.order = order;
                this.cutoffFreq = cutoffFreq;
                this.sampleRate = sampleRate;
                
                // Calculate filter coefficients
                const wc = 2 * Math.PI * cutoffFreq;
                const wc_d = 2 * sampleRate * Math.tan(wc / (2 * sampleRate));
                const k = wc_d / 2;
                
                // 2nd order Butterworth coefficients
                const a = k * k / (1 + Math.sqrt(2) * k + k * k);
                this.b0 = a;
                this.b1 = 2 * a;
                this.b2 = a;
                this.a1 = (2 * (k * k - 1)) / (1 + Math.sqrt(2) * k + k * k);
                this.a2 = (1 - Math.sqrt(2) * k + k * k) / (1 + Math.sqrt(2) * k + k * k);
                
                // Initialize state variables
                this.x1 = 0;
                this.x2 = 0;
                this.y1 = 0;
                this.y2 = 0;
            }
            
            filter(data) {
                const filtered = [];
                
                for (let i = 0; i < data.length; i++) {
                    // Apply difference equation
                    const x0 = data[i];
                    const y0 = this.b0 * x0 + this.b1 * this.x1 + this.b2 * this.x2 
                              - this.a1 * this.y1 - this.a2 * this.y2;
                    
                    filtered.push(y0);
                    
                    // Update state variables
                    this.x2 = this.x1;
                    this.x1 = x0;
                    this.y2 = this.y1;
                    this.y1 = y0;
                }
                
                return filtered;
            }
        }
        
        // ===== GEAR RATIO DATABASE =====
        const GEAR_RATIOS = {
            '2022-wrx': {
                gears: {
                    1: 3.455,
                    2: 1.947,
                    3: 1.367,
                    4: 1.029,
                    5: 0.825,
                    6: 0.667
                },
                final: 4.111,
                name: '2022+ WRX FA24'
            },
            '2015-2021-wrx': {
                gears: {
                    1: 3.636,
                    2: 2.235,
                    3: 1.521,
                    4: 1.137,
                    5: 0.971,
                    6: 0.756
                },
                final: 4.111,
                name: '2015-2021 WRX FA20'
            },
            '2015-2021-sti': {
                gears: {
                    1: 3.636,
                    2: 2.375,
                    3: 1.761,
                    4: 1.346,
                    5: 0.971,
                    6: 0.756
                },
                final: 3.900,
                name: '2015-2021 STI EJ257'
            },
            '2008-2014-wrx': {
                gears: {
                    1: 3.454,
                    2: 1.947,
                    3: 1.366,
                    4: 0.972,
                    5: 0.738
                },
                final: 4.444,
                name: '2008-2014 WRX EJ255'
            },
            '2004-2007-sti': {
                gears: {
                    1: 3.636,
                    2: 2.375,
                    3: 1.761,
                    4: 1.346,
                    5: 0.971,
                    6: 0.756
                },
                final: 3.900,
                name: '2004-2007 STI EJ257'
            }
        };
        
        // ===== RPM-BASED POWER CALCULATOR =====
        class PowerCalculator {
            constructor(config) {
                // Vehicle parameters
                this.totalWeight = config.totalWeight || 3500; // lbs
                this.totalWeightKg = this.totalWeight * 0.453592; // Convert to kg
                this.vehicle = config.vehicle || '2022-wrx';
                this.gearRatios = GEAR_RATIOS[this.vehicle] || GEAR_RATIOS['2022-wrx'];
                this.selectedGear = config.selectedGear || 3;
                this.tireSize = config.tireSize || '245/40R18';
                this.tireDiameter = this.calculateTireDiameter(this.tireSize); // meters
                this.tireCircumference = Math.PI * this.tireDiameter; // meters
                
                // Physics constants
                this.g = 9.81; // m/s²
                this.airDensity = 1.225; // kg/m³ at sea level
                this.Cd = 0.35; // Drag coefficient (WRX/STI)
                this.frontalArea = 2.32; // m² (WRX/STI)
                this.rollingResistance = 0.013; // Performance tires
                
                // SAE Correction
                this.saeEnabled = config.saeEnabled !== false;
                this.ambientTemp = config.ambientTemp || 77; // °F
                this.baroPressure = config.baroPressure || 29.92; // inHg
                this.humidity = config.humidity || 0; // %
                
                // Smoothing
                this.smoothingLevel = config.smoothingLevel || 3;
                
                // Filter parameters
                this.sampleRate = 50; // Hz target
                this.filterCutoff = 10; // Hz
                this.filterOrder = 2; // 2nd order Butterworth
                
                // Dynojet mode
                this.dynojetMode = config.dynojetMode || false;
            }
            
            calculateTireDiameter(tireSize) {
                // Parse tire size like "245/40R18"
                const match = tireSize.match(/(\d+)\/(\d+)R(\d+)/);
                if (!match) return 0.65; // Default ~25.6 inches in meters
                
                const width = parseInt(match[1]); // mm
                const aspectRatio = parseInt(match[2]); // percentage
                const rimDiameter = parseInt(match[3]); // inches
                
                // Calculate tire diameter
                const sidewallHeight = (width * aspectRatio / 100) / 1000; // meters
                const rimDiameterMeters = rimDiameter * 0.0254; // inches to meters
                const tireDiameter = rimDiameterMeters + (2 * sidewallHeight);
                
                return tireDiameter;
            }
            
            calculateSAECorrection() {
                if (!this.saeEnabled) return 1.0;
                
                // Convert inputs to proper units
                const tempK = (this.ambientTemp - 32) * 5/9 + 273.15; // °F to Kelvin
                const pressurePa = this.baroPressure * 3386.39; // inHg to Pa
                
                // SAE J1349 standard conditions
                const stdTempK = 298.15; // 25°C
                const stdPressurePa = 99000; // 990 mbar
                
                // Correction factor (simplified SAE J1349)
                const cf = Math.sqrt(stdTempK / tempK) * (pressurePa / stdPressurePa);
                
                // Limit correction to reasonable range (0.85 to 1.15)
                return Math.max(0.85, Math.min(1.15, cf));
            }
            
            findPulls(data) {
                const pulls = [];
                let currentPull = [];
                let inPull = false;
                
                // Find throttle column
                const throttleColumns = [
                    'Throttle Pos (%)', 'Accel Position (%)', 'Throttle Position (%)',
                    'TPS (%)', 'APS (%)', 'Accelerator Position (%)'
                ];
                
                let throttleColumn = null;
                for (const col of throttleColumns) {
                    if (data[0] && data[0][col] !== undefined) {
                        throttleColumn = col;
                        break;
                    }
                }
                
                if (!throttleColumn) {
                    console.error('No throttle column found!');
                    return pulls;
                }
                
                // Process data
                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    let throttle = parseFloat(row[throttleColumn] || 0);
                    
                    // Handle 0-1 scale
                    if (throttle <= 1.0 && throttle > 0) {
                        throttle *= 100;
                    }
                    
                    const rpm = parseInt(row['RPM (RPM)'] || row['RPM'] || 0);
                    const speed = parseFloat(row['Vehicle Speed (mph)'] || row['Speed (mph)'] || 0);
                    
                    // Detect WOT pull (throttle > 90% and reasonable RPM/speed)
                    if (throttle > 90 && rpm > 2500 && speed > 25) {
                        if (!inPull) {
                            inPull = true;
                            currentPull = [];
                            console.log(`Starting pull at ${row['Time (sec)']}s, TPS: ${throttle.toFixed(1)}%`);
                        }
                        
                        currentPull.push({
                            time: parseFloat(row['Time (sec)'] || 0),
                            rpm: rpm,
                            speed: speed * 0.44704, // Convert mph to m/s
                            speedMPH: speed,
                            throttle: throttle,
                            boost: this.parseBoost(row),
                            afr: parseFloat(row['AF Sens 1 Ratio (AFR)'] || row['AFR'] || 14.7),
                            knock: parseFloat(row['Feedback Knock (°)'] || 0),
                            dam: parseFloat(row['Dyn Adv Mult (DAM)'] || 1),
                            gear: this.selectedGear
                        });
                    } else if (inPull && (throttle < 85 || rpm < 2000)) {
                        // End of pull
                        if (currentPull.length > 40) { // Minimum 40 samples for valid pull
                            console.log(`Ending pull with ${currentPull.length} points`);
                            pulls.push(currentPull);
                        }
                        inPull = false;
                        currentPull = [];
                    }
                }
                
                // Don't forget last pull
                if (inPull && currentPull.length > 40) {
                    pulls.push(currentPull);
                }
                
                console.log(`Found ${pulls.length} valid pulls`);
                return pulls;
            }
            
            parseBoost(row) {
                let boost = parseFloat(row['Boost (psi)'] || 0);
                
                if (boost === 0) {
                    const map = parseFloat(row['Man Abs Press (psi)'] || row['MAP (psi)'] || 14.7);
                    boost = map - 14.7;
                }
                
                return Math.max(0, boost);
            }
            
            calculatePowerAndTorque(pull) {
                // Step 1: Extract RPM data and calculate sample rate
                const rpmData = pull.map(p => p.rpm);
                const timeData = pull.map(p => p.time);
                
                // Calculate actual sample rate
                const avgDt = (timeData[timeData.length - 1] - timeData[0]) / (timeData.length - 1);
                const actualSampleRate = 1 / avgDt;
                console.log(`Sample rate: ${actualSampleRate.toFixed(1)} Hz`);
                
                // Step 2: Apply Butterworth filter to RPM data
                const filter = new ButterworthFilter(this.filterOrder, this.filterCutoff, actualSampleRate);
                const filteredRPM = filter.filter(rpmData);
                
                // Step 3: Calculate wheel speed from filtered RPM
                const gearRatio = this.gearRatios.gears[this.selectedGear];
                const totalRatio = gearRatio * this.gearRatios.final;
                
                const wheelSpeeds = filteredRPM.map(rpm => {
                    const wheelRPM = rpm / totalRatio;
                    return (wheelRPM * this.tireCircumference) / 60; // m/s
                });
                
                // Step 4: Calculate acceleration (with additional smoothing)
                const accelerations = [];
                const windowSize = 5; // points for derivative
                
                for (let i = windowSize; i < wheelSpeeds.length - windowSize; i++) {
                    // Use central difference for better accuracy
                    const dt = timeData[i + windowSize] - timeData[i - windowSize];
                    const dv = wheelSpeeds[i + windowSize] - wheelSpeeds[i - windowSize];
                    
                    if (dt > 0 && dt < 1) { // Sanity check
                        const accel = dv / dt;
                        if (Math.abs(accel) < 5 && accel > -0.5) { // Reasonable limits
                            accelerations.push({
                                index: i,
                                time: timeData[i],
                                rpm: filteredRPM[i],
                                speed: wheelSpeeds[i],
                                accel: accel,
                                boost: pull[i].boost,
                                afr: pull[i].afr
                            });
                        }
                    }
                }
                
                // Step 5: Apply another smoothing pass to acceleration
                const smoothedAccel = this.smoothAcceleration(accelerations);
                
                // Step 6: Calculate power for each point
                const results = [];
                const cf = this.calculateSAECorrection();
                
                // Constants for calculations
                const rho = this.airDensity;
                const CdA = this.Cd * this.frontalArea;
                const Crr = this.rollingResistance;
                
                for (const point of smoothedAccel) {
                    // Forces in Newtons
                    const F_accel = this.totalWeightKg * point.accel;
                    const F_aero = 0.5 * rho * CdA * point.speed * point.speed;
                    const F_rolling = Crr * this.totalWeightKg * this.g;
                    
                    // Total force at wheels
                    const F_total = F_accel + F_aero + F_rolling;
                    
                    // Power at wheels (watts)
                    const powerWatts = F_total * point.speed;
                    
                    // Convert to wheel horsepower with SAE correction
                    let wheelHP = (powerWatts / 745.7) * cf;
                    
                    // Apply Dynojet mode if enabled (adds 18%)
                    if (this.dynojetMode) {
                        wheelHP *= 1.18;
                    }
                    
                    // Calculate torque from power
                    const torqueLbFt = (wheelHP * 5252) / point.rpm;
                    
                    // Quality checks
                    if (wheelHP > 50 && wheelHP < 800 && 
                        torqueLbFt > 50 && torqueLbFt < 800 &&
                        point.rpm > 2500 && point.rpm < 7500) {
                        
                        // Check for slip
                        const theoreticalSpeed = (point.rpm * this.tireCircumference) / (totalRatio * 60);
                        const actualSpeed = pull[point.index] ? pull[point.index].speed : point.speed;
                        const slipRatio = (theoreticalSpeed - actualSpeed) / theoreticalSpeed;
                        
                        results.push({
                            time: point.time,
                            rpm: point.rpm,
                            speed: wheelSpeeds[point.index] * 2.23694, // m/s to mph
                            power: wheelHP,
                            torque: torqueLbFt,
                            boost: point.boost,
                            afr: point.afr,
                            accel: point.accel,
                            slip: slipRatio * 100 // percentage
                        });
                    }
                }
                
                console.log(`Calculated ${results.length} power points`);
                if (results.length > 0) {
                    const maxPower = Math.max(...results.map(r => r.power));
                    const maxTorque = Math.max(...results.map(r => r.torque));
                    const avgSlip = results.reduce((sum, r) => sum + Math.abs(r.slip), 0) / results.length;
                    console.log(`Peak: ${maxPower.toFixed(1)} HP, ${maxTorque.toFixed(1)} TQ`);
                    console.log(`Average slip: ${avgSlip.toFixed(1)}%`);
                    console.log(`SAE CF: ${cf.toFixed(3)}`);
                    console.log(`Dynojet mode: ${this.dynojetMode ? 'ON' : 'OFF'}`);
                }
                
                return results;
            }
            
            smoothAcceleration(accelData) {
                // Moving average smoothing for acceleration
                const windowRadius = 3;
                const smoothed = [];
                
                for (let i = 0; i < accelData.length; i++) {
                    let sumAccel = 0;
                    let count = 0;
                    
                    for (let j = Math.max(0, i - windowRadius); 
                         j <= Math.min(accelData.length - 1, i + windowRadius); j++) {
                        sumAccel += accelData[j].accel;
                        count++;
                    }
                    
                    smoothed.push({
                        ...accelData[i],
                        accel: sumAccel / count
                    });
                }
                
                return smoothed;
            }
            
            smoothResults(results) {
                if (this.smoothingLevel === 0 || results.length < 5) return results;
                
                // Sort by RPM
                const sorted = [...results].sort((a, b) => a.rpm - b.rpm);
                
                // Determine bin size based on smoothing level
                // More aggressive binning for visible smoothing
                const binSizes = [0, 50, 40, 30, 20, 15];
                const binSize = binSizes[Math.min(this.smoothingLevel, 5)];
                const bins = {};
                
                // Group into RPM bins
                sorted.forEach(point => {
                    const bin = Math.round(point.rpm / binSize) * binSize;
                    if (!bins[bin]) bins[bin] = [];
                    bins[bin].push(point);
                });
                
                // Average each bin
                const binned = [];
                Object.keys(bins).sort((a, b) => parseInt(a) - parseInt(b)).forEach(bin => {
                    const points = bins[bin];
                    if (points.length > 0) {
                        binned.push({
                            rpm: parseInt(bin),
                            power: points.reduce((sum, p) => sum + p.power, 0) / points.length,
                            torque: points.reduce((sum, p) => sum + p.torque, 0) / points.length,
                            boost: points.reduce((sum, p) => sum + p.boost, 0) / points.length,
                            afr: points.reduce((sum, p) => sum + p.afr, 0) / points.length,
                            slip: points.reduce((sum, p) => sum + p.slip, 0) / points.length,
                            speed: points[Math.floor(points.length / 2)].speed,
                            time: points[Math.floor(points.length / 2)].time
                        });
                    }
                });
                
                // Apply additional smoothing based on level
                // Larger window radius provides stronger smoothing effect
                const windowSizes = [0, 2, 4, 6, 8, 10];
                const windowRadius = windowSizes[Math.min(this.smoothingLevel, 5)];
                
                const smoothed = [];
                for (let i = 0; i < binned.length; i++) {
                    if (windowRadius === 0) {
                        smoothed.push(binned[i]);
                    } else {
                        let powerSum = 0, torqueSum = 0, boostSum = 0, afrSum = 0, slipSum = 0;
                        let count = 0;
                        
                        for (let j = Math.max(0, i - windowRadius); 
                             j <= Math.min(binned.length - 1, i + windowRadius); j++) {
                            powerSum += binned[j].power;
                            torqueSum += binned[j].torque;
                            boostSum += binned[j].boost;
                            afrSum += binned[j].afr;
                            slipSum += binned[j].slip;
                            count++;
                        }
                        
                        smoothed.push({
                            ...binned[i],
                            power: powerSum / count,
                            torque: torqueSum / count,
                            boost: boostSum / count,
                            afr: afrSum / count,
                            slip: slipSum / count
                        });
                    }
                }
                
                return smoothed;
            }
        }
        
        // ===== MAIN APPLICATION CLASS =====
        class TuneAnalyzer {
            constructor() {
                this.uploadedFile = null;
                this.userLog = null;
                this.baselineLog = null;
                this.config = {};
                this.analysisData = null;
                this.baselineData = null;
                this.chartOptions = {
                    showPower: true,
                    showTorque: false,
                    showBoost: false,
                    showAFR: false,
                    showSlip: false
                };
                this.hideBaseline = false;
                this.dynojetMode = false;
                
                this.initializeEventListeners();
                this.initializeSAEControls();
            }
            
            initializeEventListeners() {
                // Upload handling
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'text/csv') {
                        this.handleFile(files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });
                
                // Form inputs
                document.querySelectorAll('.form-input').forEach(input => {
                    input.addEventListener('change', () => this.checkFormCompletion());
                });
                
                // Vehicle selection triggers baseline loading
                document.getElementById('vehicle').addEventListener('change', () => {
                    this.checkFormCompletion();
                    this.loadBaselineData();
                });
                
                document.getElementById('modLevel').addEventListener('change', () => {
                    this.checkFormCompletion();
                    this.loadBaselineData();
                });
                
                document.getElementById('fuel').addEventListener('change', () => {
                    this.checkFormCompletion();
                    this.loadBaselineData();
                });
                
                // Analyze button
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyze());
            }
            
            initializeSAEControls() {
                const saeToggle = document.getElementById('saeToggle');
                const saeInputs = document.getElementById('saeInputs');
                
                saeToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        saeInputs.style.display = 'grid';
                    } else {
                        saeInputs.style.display = 'none';
                    }
                });
            }
            
            initializeChartControls() {
                // Chart checkboxes
                ['showPower', 'showTorque', 'showBoost', 'showAFR', 'showSlip', 'hideBaseline', 'dynojetMode'].forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            if (id === 'hideBaseline') {
                                this.hideBaseline = e.target.checked;
                            } else if (id === 'dynojetMode') {
                                this.dynojetMode = e.target.checked;
                                // Recalculate with new mode
                                if (this.analysisData) {
                                    this.recalculateWithDynojetMode();

                                    // Force refresh by toggling power checkbox
                                    const powerCheckbox = document.getElementById('showPower');
                                    if (powerCheckbox) {
                                        const wasChecked = powerCheckbox.checked;
                                        powerCheckbox.checked = false;
                                        this.chartOptions.showPower = false;

                                        setTimeout(() => {
                                            powerCheckbox.checked = wasChecked;
                                            this.chartOptions.showPower = wasChecked;
                                            this.createDynoChart();
                                        }, 10);
                                    }
                                }
                                return;
                            } else {
                                this.chartOptions[id] = e.target.checked;
                            }
                            if (this.analysisData) {
                                this.createDynoChart();
                            }
                        });
                    }
                });
                
                // Smoothing control
                const smoothingSelect = document.getElementById('smoothingLevel');
                if (smoothingSelect) {
                    smoothingSelect.addEventListener('change', (e) => {
                        const level = parseInt(e.target.value);
                        if (this.analysisData) {
                            this.recalculateWithSmoothing(level);

                            // Force refresh by toggling power checkbox
                            const powerCheckbox = document.getElementById('showPower');
                            if (powerCheckbox) {
                                const wasChecked = powerCheckbox.checked;
                                powerCheckbox.checked = false;
                                this.chartOptions.showPower = false;

                                setTimeout(() => {
                                    powerCheckbox.checked = wasChecked;
                                    this.chartOptions.showPower = wasChecked;
                                    this.createDynoChart();
                                }, 10);
                            }
                        }
                    });
                }
                
                // Download button
                setTimeout(() => {
                    const downloadBtn = document.getElementById('downloadReportBtn');
                    if (downloadBtn && !downloadBtn.hasAttribute('data-initialized')) {
                        downloadBtn.setAttribute('data-initialized', 'true');
                        downloadBtn.addEventListener('click', () => this.downloadReport());
                    }
                }, 100);
            }
            
            async loadBaselineData() {
                const vehicle = document.getElementById('vehicle').value;
                const modLevel = document.getElementById('modLevel').value;
                const fuel = document.getElementById('fuel').value;
                
                if (!vehicle || !modLevel || !fuel) {
                    return;
                }
                
                // Construct baseline filename
                const baselineFile = `baseline-logs/${vehicle}-${modLevel}-${fuel}.csv`;
                console.log(`Looking for baseline: ${baselineFile}`);
                
                try {
                    const response = await fetch(baselineFile);
                    if (response.ok) {
                        const text = await response.text();
                        this.baselineLog = CSVParser.parse(text);
                        console.log(`Loaded baseline with ${this.baselineLog.data.length} rows`);
                        
                        // Remove any baseline request message if it exists
                        const msg = document.querySelector('.baseline-message');
                        if (msg) msg.remove();
                    } else {
                        // Baseline not found
                        this.baselineLog = null;
                        console.log('No baseline found');
                        this.showBaselineRequestMessage();
                    }
                } catch (error) {
                    console.error('Error loading baseline:', error);
                    this.baselineLog = null;
                    this.showBaselineRequestMessage();
                }
            }
            
            showBaselineRequestMessage() {
                // Remove existing message if any
                const existing = document.querySelector('.baseline-message');
                if (existing) existing.remove();
                
                // Add message after config section
                const configSection = document.getElementById('configSection');
                const message = document.createElement('div');
                message.className = 'baseline-message';
                message.innerHTML = `
                    <p>No baseline data available for this configuration yet.</p>
                    <button onclick="window.tuneAnalyzer.requestBaseline()">Request This Baseline</button>
                `;
                configSection.appendChild(message);
            }
            
            requestBaseline() {
                const vehicle = document.getElementById('vehicle').value;
                const modLevel = document.getElementById('modLevel').value;
                const fuel = document.getElementById('fuel').value;
                
                const config = `${vehicle}-${modLevel}-${fuel}`;
                
                // Log the request (in a real app, this would send an email or save to database)
                console.log(`Baseline requested: ${config}`);
                alert(`Baseline request noted for: ${config}\n\nWe'll add this configuration soon!`);
                
                // Update message
                const msg = document.querySelector('.baseline-message');
                if (msg) {
                    msg.innerHTML = '<p>✓ Baseline request submitted. Thank you!</p>';
                }
            }
            
            handleFile(file) {
                this.uploadedFile = file;
                
                // Update UI
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.innerHTML = `
                    <div class="upload-icon">✓</div>
                    <div class="upload-text">${file.name}</div>
                    <div class="file-info">Log loaded successfully</div>
                `;
                
                // Show configuration
                document.getElementById('configSection').classList.add('show');
                
                // Read file
                const reader = new FileReader();
                reader.onload = (e) => {
                    const parsed = CSVParser.parse(e.target.result);
                    this.userLog = parsed;
                    
                    console.log(`Loaded ${parsed.data.length} rows`);
                    console.log('Columns:', Object.keys(parsed.data[0] || {}));
                };
                reader.readAsText(file);
                
                this.checkFormCompletion();
            }
            
            checkFormCompletion() {
                const required = ['vehicle', 'modLevel', 'fuel', 'safety', 'weight', 'driverWeight', 'selectedGear'];
                const allFilled = required.every(id => document.getElementById(id).value);
                
                document.getElementById('analyzeBtn').disabled = !this.uploadedFile || !allFilled;
            }
            
            async analyze() {
                // Gather all config
                const baseWeight = parseFloat(document.getElementById('weight').value) || 3500;
                const driverWeight = parseFloat(document.getElementById('driverWeight').value) || 180;
                const passengers = parseInt(document.getElementById('passengers').value) || 0;
                const totalWeight = baseWeight + driverWeight + (passengers * 150);
                
                this.config = {
                    vehicle: document.getElementById('vehicle').value,
                    modLevel: document.getElementById('modLevel').value,
                    fuel: document.getElementById('fuel').value,
                    safety: document.getElementById('safety').value,
                    totalWeight: totalWeight,
                    tireSize: document.getElementById('tireSize').value,
                    selectedGear: parseInt(document.getElementById('selectedGear').value),
                    transmission: document.getElementById('transmission').value,
                    // SAE Correction
                    saeEnabled: document.getElementById('saeToggle').checked,
                    ambientTemp: parseFloat(document.getElementById('ambientTemp').value) || 77,
                    baroPressure: parseFloat(document.getElementById('baroPressure').value) || 29.92,
                    elevation: parseFloat(document.getElementById('elevation').value) || 0,
                    humidity: parseFloat(document.getElementById('humidity').value) || 0,
                    // Smoothing
                    smoothingLevel: parseInt(document.getElementById('smoothingLevel').value) || 3,
                    // Dynojet mode
                    dynojetMode: this.dynojetMode
                };
                
                // Show loading
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Simulate steps
                await this.simulateAnalysisSteps();
                
                // Calculate
                this.calculateResults();
                
                // Show results
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                
                // Init controls
                this.initializeChartControls();
            }
            
            async simulateAnalysisSteps() {
                const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
                
                for (const step of steps) {
                    document.getElementById(step).classList.add('active');
                    await new Promise(r => setTimeout(r, 600));
                    document.getElementById(step).classList.remove('active');
                    document.getElementById(step).classList.add('complete');
                }
            }
            
            calculateResults() {
                // Create Power Calculator instance for user data
                const calculator = new PowerCalculator({
                    ...this.config,
                    dynojetMode: this.dynojetMode
                });
                
                // Find pulls in user data
                const pulls = calculator.findPulls(this.userLog.data);
                
                let currentPower = 200;
                let currentTorque = 220;
                let currentBoost = 15;
                let powerCurve = null;
                let rawPowerCurve = null;
                let maxSlip = 0;
                let avgSlip = 0;
                
                if (pulls.length > 0) {
                    // Use longest pull
                    const longestPull = pulls.reduce((a, b) => a.length > b.length ? a : b);
                    console.log(`Using pull with ${longestPull.length} samples`);
                    
                    // Calculate power
                    rawPowerCurve = calculator.calculatePowerAndTorque(longestPull);
                    
                    if (rawPowerCurve && rawPowerCurve.length > 0) {
                        // Store raw data before smoothing
                        powerCurve = calculator.smoothResults(rawPowerCurve);
                        
                        currentPower = Math.round(Math.max(...powerCurve.map(p => p.power)));
                        currentTorque = Math.round(Math.max(...powerCurve.map(p => p.torque)));
                        currentBoost = Math.round(Math.max(...powerCurve.map(p => p.boost)) * 10) / 10;
                        
                        // Calculate slip statistics
                        const slipValues = powerCurve.map(p => Math.abs(p.slip));
                        maxSlip = Math.max(...slipValues);
                        avgSlip = slipValues.reduce((a, b) => a + b, 0) / slipValues.length;
                    }
                    
                    // Store data
                    this.analysisData = {
                        pull: longestPull,
                        rawPowerCurve: rawPowerCurve,
                        powerCurve: powerCurve,
                        calculator: calculator
                    };
                } else {
                    this.analysisData = null;
                }
                
                // Process baseline data if available
                if (this.baselineLog && this.baselineLog.data.length > 0) {
                    console.log('Processing baseline data...');
                    const baselineCalculator = new PowerCalculator({
                        ...this.config,
                        dynojetMode: this.dynojetMode
                    });
                    const baselinePulls = baselineCalculator.findPulls(this.baselineLog.data);
                    
                    if (baselinePulls.length > 0) {
                        const longestBaselinePull = baselinePulls.reduce((a, b) => a.length > b.length ? a : b);
                        const rawBaselineCurve = baselineCalculator.calculatePowerAndTorque(longestBaselinePull);
                        
                        if (rawBaselineCurve && rawBaselineCurve.length > 0) {
                            const baselineCurve = baselineCalculator.smoothResults(rawBaselineCurve);
                            
                            this.baselineData = {
                                pull: longestBaselinePull,
                                rawPowerCurve: rawBaselineCurve,
                                powerCurve: baselineCurve,
                                calculator: baselineCalculator
                            };
                            
                            console.log('Baseline processed successfully');
                        }
                    }
                }
                
                // Calculate potential
                const potentialPower = this.calculatePotentialPower();
                const potentialTorque = this.calculatePotentialTorque();
                const powerGain = Math.max(0, potentialPower - currentPower);
                
                // Update UI
                document.getElementById('powerGainValue').textContent = powerGain;
                document.getElementById('currentPower').textContent = currentPower;
                document.getElementById('potentialPower').textContent = potentialPower;
                document.getElementById('boostValue').textContent = currentBoost;
                document.getElementById('boostPotential').textContent = this.getBoostLimit();
                
                // Update power card with torque
                const powerCard = document.querySelector('.analysis-card:first-child');
                const dynoType = this.dynojetMode ? 'Dynojet' : 'Mustang';
                powerCard.querySelector('.analysis-value').innerHTML = 
                    `${currentPower} WHP / <span style="font-size: 1.8rem; opacity: 0.8;">${currentTorque} WTQ</span>`;
                powerCard.querySelector('.analysis-description').innerHTML = 
                    `Current output (${dynoType}). M-TUNED potential: ${potentialPower} WHP / ${potentialTorque} WTQ`;
                
                // Check for issues
                this.analyzeForIssues();
                
                // Update slip card
                const slipCard = document.getElementById('slipCard');
                if (maxSlip > 3 || avgSlip > 2) {
                    slipCard.style.display = 'block';
                    document.getElementById('slipValue').textContent = avgSlip.toFixed(1);
                    
                    if (maxSlip > 5) {
                        slipCard.classList.remove('warning');
                        slipCard.classList.add('danger');
                        document.getElementById('slipDescription').textContent = 
                            'Significant clutch slip detected - results may be inaccurate';
                    } else {
                        slipCard.classList.remove('danger');
                        slipCard.classList.add('warning');
                        document.getElementById('slipDescription').textContent = 
                            'Minor slip detected - consider clutch upgrade for accurate results';
                    }
                } else {
                    slipCard.style.display = 'none';
                }
                
                // Create chart
                this.createDynoChart();
            }
            
            recalculateWithSmoothing(level) {
                if (!this.analysisData || !this.analysisData.rawPowerCurve) return;
                
                // Update smoothing level
                this.config.smoothingLevel = level;
                
                // Apply smoothing to USER data
                const calculator = new PowerCalculator({
                    ...this.config,
                    dynojetMode: this.dynojetMode
                });
                let smoothedCurve;
                
                if (level === 0) {
                    // No smoothing - use raw data
                    smoothedCurve = [...this.analysisData.rawPowerCurve];
                } else {
                    // Apply smoothing to existing raw data
                    smoothedCurve = calculator.smoothResults(this.analysisData.rawPowerCurve);
                }
                
                // Update displayed data
                this.analysisData.powerCurve = smoothedCurve;
                
                // Apply smoothing to BASELINE data if it exists
                if (this.baselineData && this.baselineData.rawPowerCurve) {
                    const baselineCalculator = new PowerCalculator({
                        ...this.config,
                        dynojetMode: this.dynojetMode
                    });
                    let smoothedBaselineCurve;
                    
                    if (level === 0) {
                        smoothedBaselineCurve = [...this.baselineData.rawPowerCurve];
                    } else {
                        smoothedBaselineCurve = baselineCalculator.smoothResults(this.baselineData.rawPowerCurve);
                    }
                    
                    this.baselineData.powerCurve = smoothedBaselineCurve;
                }
                
                if (smoothedCurve.length > 0) {
                    // Update peak values
                    const currentPower = Math.round(Math.max(...smoothedCurve.map(p => p.power)));
                    const currentTorque = Math.round(Math.max(...smoothedCurve.map(p => p.torque)));
                    
                    // Update UI
                    document.getElementById('currentPower').textContent = currentPower;
                    document.getElementById('powerGainValue').textContent = 
                        Math.max(0, this.calculatePotentialPower() - currentPower);
                    
                    const powerCard = document.querySelector('.analysis-card:first-child');
                    const dynoType = this.dynojetMode ? 'Dynojet' : 'Mustang';
                    powerCard.querySelector('.analysis-value').innerHTML = 
                        `${currentPower} WHP / <span style="font-size: 1.8rem; opacity: 0.8;">${currentTorque} WTQ</span>`;
                    
                    // Redraw chart
                    this.createDynoChart();
                }
            }
            
            recalculateWithDynojetMode() {
                // Update config
                this.config.dynojetMode = this.dynojetMode;
                
                // Recalculate USER data
                if (this.analysisData && this.analysisData.pull) {
                    const calculator = new PowerCalculator({
                        ...this.config,
                        dynojetMode: this.dynojetMode
                    });
                    const rawPowerCurve = calculator.calculatePowerAndTorque(this.analysisData.pull);
                    
                    if (rawPowerCurve && rawPowerCurve.length > 0) {
                        const powerCurve = calculator.smoothResults(rawPowerCurve);
                        
                        this.analysisData.rawPowerCurve = rawPowerCurve;
                        this.analysisData.powerCurve = powerCurve;
                        
                        // Update values
                        const currentPower = Math.round(Math.max(...powerCurve.map(p => p.power)));
                        const currentTorque = Math.round(Math.max(...powerCurve.map(p => p.torque)));
                        
                        // Recalculate potential with Dynojet mode
                        const potentialPower = this.calculatePotentialPower();
                        const potentialTorque = this.calculatePotentialTorque();
                        const powerGain = Math.max(0, potentialPower - currentPower);
                        
                        // Update UI
                        document.getElementById('powerGainValue').textContent = powerGain;
                        document.getElementById('currentPower').textContent = currentPower;
                        document.getElementById('potentialPower').textContent = potentialPower;
                        
                        const powerCard = document.querySelector('.analysis-card:first-child');
                        const dynoType = this.dynojetMode ? 'Dynojet' : 'Mustang';
                        powerCard.querySelector('.analysis-value').innerHTML = 
                            `${currentPower} WHP / <span style="font-size: 1.8rem; opacity: 0.8;">${currentTorque} WTQ</span>`;
                        powerCard.querySelector('.analysis-description').innerHTML = 
                            `Current output (${dynoType}). M-TUNED potential: ${potentialPower} WHP / ${potentialTorque} WTQ`;
                    }
                }
                
                // Recalculate BASELINE data
                if (this.baselineData && this.baselineData.pull) {
                    const baselineCalculator = new PowerCalculator({
                        ...this.config,
                        dynojetMode: this.dynojetMode
                    });
                    const rawBaselineCurve = baselineCalculator.calculatePowerAndTorque(this.baselineData.pull);
                    
                    if (rawBaselineCurve && rawBaselineCurve.length > 0) {
                        const baselineCurve = baselineCalculator.smoothResults(rawBaselineCurve);
                        
                        this.baselineData.rawPowerCurve = rawBaselineCurve;
                        this.baselineData.powerCurve = baselineCurve;
                    }
                }
                
                // Redraw chart
                this.createDynoChart();
            }
            
            analyzeForIssues() {
                if (!this.userLog || !this.userLog.data) return;
                
                // Check knock
                let maxKnock = 0;
                let knockEvents = 0;
                let damDropped = false;
                let avgFuelTrim = 0;
                let trimCount = 0;
                
                this.userLog.data.forEach(row => {
                    const knock = Math.abs(parseFloat(row['Feedback Knock (°)'] || 0));
                    const dam = parseFloat(row['Dyn Adv Mult (DAM)'] || 1);
                    const trim = parseFloat(row['AF 1 Trims Total (%)'] || 0);
                    
                    if (knock > 2.5) {
                        knockEvents++;
                        maxKnock = Math.max(maxKnock, knock);
                    }
                    
                    if (dam < 1.0) damDropped = true;
                    
                    if (!isNaN(trim)) {
                        avgFuelTrim += trim;
                        trimCount++;
                    }
                });
                
                // Update knock card
                const knockCard = document.getElementById('knockCard');
                if (knockEvents > 0 || damDropped) {
                    knockCard.style.display = 'block';
                    document.getElementById('knockValue').textContent = maxKnock.toFixed(1);
                    
                    if (damDropped) {
                        knockCard.querySelector('.analysis-description').textContent = 
                            'DAM dropped below 1.0. Immediate attention required.';
                    }
                }
                
                // Update fuel trim
                if (trimCount > 0) {
                    avgFuelTrim = avgFuelTrim / trimCount;
                    document.getElementById('fuelTrimValue').textContent = 
                        (avgFuelTrim > 0 ? '+' : '') + avgFuelTrim.toFixed(1);
                    
                    const trimCard = document.querySelector('.analysis-card:nth-child(3)');
                    trimCard.classList.remove('good', 'warning', 'danger');
                    
                    if (Math.abs(avgFuelTrim) <= 5) {
                        trimCard.classList.add('good');
                    } else if (Math.abs(avgFuelTrim) <= 10) {
                        trimCard.classList.add('warning');
                    } else {
                        trimCard.classList.add('danger');
                    }
                }
            }
            
            calculatePotentialPower() {
                const basePower = {
                    '2022-wrx': { stock: 240, stage1: 280, stage2: 315, stage2plus: 330, flex: 350, bigturbo: 400, built: 500 },
                    '2015-2021-wrx': { stock: 220, stage1: 260, stage2: 290, stage2plus: 310, flex: 340, bigturbo: 380, built: 450 },
                    '2015-2021-sti': { stock: 260, stage1: 300, stage2: 340, stage2plus: 360, flex: 380, bigturbo: 450, built: 600 },
                    '2008-2014-wrx': { stock: 200, stage1: 250, stage2: 280, stage2plus: 300, flex: 330, bigturbo: 380, built: 450 },
                    '2004-2007-sti': { stock: 250, stage1: 300, stage2: 340, stage2plus: 360, flex: 380, bigturbo: 450, built: 600 }
                };
                
                let power = basePower[this.config.vehicle]?.[this.config.modLevel] || 300;
                
                // Fuel adjustments
                const fuelMultipliers = {
                    '91': 0.95,
                    '93': 1.0,
                    'e30': 1.05,
                    'e50': 1.08,
                    'e85': 1.10
                };
                power *= fuelMultipliers[this.config.fuel] || 1.0;
                
                // Safety adjustments
                const safetyMultipliers = {
                    'conservative': 0.95,
                    'moderate': 1.0,
                    'aggressive': 1.05,
                    'yolo': 1.10
                };
                power *= safetyMultipliers[this.config.safety] || 1.0;
                
                // Apply Dynojet mode if enabled
                if (this.dynojetMode) {
                    power *= 1.18;
                }
                
                return Math.round(power);
            }
            
            calculatePotentialTorque() {
                const baseTorque = {
                    '2022-wrx': { stock: 280, stage1: 340, stage2: 380, stage2plus: 400, flex: 420, bigturbo: 450, built: 550 },
                    '2015-2021-wrx': { stock: 260, stage1: 310, stage2: 350, stage2plus: 370, flex: 400, bigturbo: 420, built: 500 },
                    '2015-2021-sti': { stock: 310, stage1: 360, stage2: 400, stage2plus: 420, flex: 440, bigturbo: 500, built: 650 },
                    '2008-2014-wrx': { stock: 240, stage1: 290, stage2: 330, stage2plus: 350, flex: 380, bigturbo: 420, built: 500 },
                    '2004-2007-sti': { stock: 300, stage1: 350, stage2: 390, stage2plus: 410, flex: 430, bigturbo: 500, built: 650 }
                };
                
                let torque = baseTorque[this.config.vehicle]?.[this.config.modLevel] || 350;
                
                // Apply same multipliers as power
                const fuelMultipliers = {
                    '91': 0.95,
                    '93': 1.0,
                    'e30': 1.05,
                    'e50': 1.08,
                    'e85': 1.10
                };
                torque *= fuelMultipliers[this.config.fuel] || 1.0;
                
                const safetyMultipliers = {
                    'conservative': 0.95,
                    'moderate': 1.0,
                    'aggressive': 1.05,
                    'yolo': 1.10
                };
                torque *= safetyMultipliers[this.config.safety] || 1.0;
                
                // Apply Dynojet mode if enabled
                if (this.dynojetMode) {
                    torque *= 1.18;
                }
                
                return Math.round(torque);
            }
            
            getBoostLimit() {
                const boostLimits = {
                    '2022-wrx': { '91': 17, '93': 19, 'e30': 21, 'e50': 21, 'e85': 21 },
                    '2015-2021-wrx': { '91': 18, '93': 20, 'e30': 22, 'e50': 22, 'e85': 22 },
                    '2015-2021-sti': { '91': 20, '93': 22, 'e30': 24, 'e50': 24, 'e85': 24 },
                    '2008-2014-wrx': { '91': 19, '93': 21, 'e30': 23, 'e50': 23, 'e85': 23 },
                    '2004-2007-sti': { '91': 20, '93': 22, 'e30': 24, 'e50': 24, 'e85': 24 }
                };
                
                let boost = boostLimits[this.config.vehicle]?.[this.config.fuel] || 20;
                
                // Safety adjustments
                if (this.config.safety === 'conservative') boost -= 1;
                if (this.config.safety === 'aggressive') boost += 2;
                if (this.config.safety === 'yolo') boost += 3;
                
                return boost;
            }
            
            createDynoChart() {
                const chartContainer = document.getElementById('dynoChart');
                
                if (!this.analysisData || !this.analysisData.powerCurve || this.analysisData.powerCurve.length === 0) {
                    chartContainer.innerHTML = `
                        <div style="text-align: center; padding: 4rem; color: var(--silver);">
                            <p style="font-size: 1.25rem; margin-bottom: 1rem;">No valid pull data detected</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">Ensure log contains WOT pulls with TPS > 90%</p>
                        </div>
                    `;
                    return;
                }
                
                // Create premium SVG chart
                const chartHTML = this.createPremiumChart();
                chartContainer.innerHTML = chartHTML;
            }

            forceChartRefresh() {
                const chartContainer = document.getElementById('dynoChart');
                if (chartContainer) {
                    // Force immediate redraw without requestAnimationFrame
                    this.createDynoChart();
                }
            }

            createPremiumChart() {
                const data = this.analysisData.powerCurve;
                if (!data || data.length === 0) return '';
                
                // Sort data by RPM for smooth curves
                const sortedData = [...data].sort((a, b) => a.rpm - b.rpm);
                
                // Get baseline data if available
                const baselineData = (!this.hideBaseline && this.baselineData && this.baselineData.powerCurve) 
                    ? [...this.baselineData.powerCurve].sort((a, b) => a.rpm - b.rpm)
                    : null;
                
                // Find scales
                const rpmMin = 2000;
                const rpmMax = Math.min(7500, Math.max(...sortedData.map(d => d.rpm)) + 500);
                
                // Calculate max values considering both user and baseline data
                let maxPower = Math.max(...sortedData.map(d => d.power));
                let maxTorque = Math.max(...sortedData.map(d => d.torque));
                let maxBoost = Math.max(...sortedData.map(d => d.boost));
                
                if (baselineData) {
                    maxPower = Math.max(maxPower, ...baselineData.map(d => d.power));
                    maxTorque = Math.max(maxTorque, ...baselineData.map(d => d.torque));
                    maxBoost = Math.max(maxBoost, ...baselineData.map(d => d.boost));
                }
                
                // IMPROVED SCALING
                // Power/Torque scaling - round up to nearest 50
                const powerScale = Math.ceil(maxPower / 50) * 50 + 50;
                const torqueScale = Math.ceil(maxTorque / 50) * 50 + 50;
                const leftScale = Math.max(powerScale, torqueScale);
                
                // Boost scaling - double the max and round up to nearest 5
                const boostScale = Math.ceil((maxBoost * 2) / 5) * 5;
                
                // Slip scale - always 0-100
                const slipScale = 100;
                
                // Prepare series
                const series = [];
                
                if (this.chartOptions.showPower) {
                    series.push({
                        name: 'POWER',
                        unit: 'WHP',
                        color: '#22c55e',
                        strokeWidth: 4,
                        data: sortedData.map(d => ({ x: d.rpm, y: d.power })),
                        scale: leftScale,
                        axis: 'left'
                    });
                }
                
                if (this.chartOptions.showTorque) {
                    series.push({
                        name: 'TORQUE',
                        unit: 'WTQ',
                        color: '#fb923c',
                        strokeWidth: 4,
                        data: sortedData.map(d => ({ x: d.rpm, y: d.torque })),
                        scale: leftScale,
                        axis: 'left'
                    });
                }
                
                if (this.chartOptions.showBoost) {
                    series.push({
                        name: 'BOOST',
                        unit: 'PSI',
                        color: '#0ea5e9',
                        strokeWidth: 3,
                        data: sortedData.map(d => ({ x: d.rpm, y: d.boost })),
                        scale: boostScale,
                        axis: 'right'
                    });
                }
                
                if (this.chartOptions.showAFR) {
                    series.push({
                        name: 'AFR',
                        unit: '',
                        color: '#a855f7',
                        strokeWidth: 3,
                        data: sortedData.map(d => ({ x: d.rpm, y: d.afr })),
                        scale: 20,
                        axis: 'right2',
                        offset: 10
                    });
                }
                
                if (this.chartOptions.showSlip) {
                    series.push({
                        name: 'SLIP',
                        unit: '%',
                        color: '#f59e0b',
                        strokeWidth: 3,
                        data: sortedData.map(d => ({ x: d.rpm, y: d.slip || 0 })),
                        scale: slipScale,
                        axis: 'right3'
                    });
                }
                
                // Chart dimensions
                const width = 1200;
                const height = 700;
                const padding = { top: 80, right: 120, bottom: 100, left: 120 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                // Create smooth curves using cubic bezier interpolation
                const createSmoothPath = (points) => {
                    if (points.length < 2) return '';
                    
                    let path = `M ${points[0].x},${points[0].y}`;
                    
                    for (let i = 1; i < points.length; i++) {
                        const p0 = points[i - 1];
                        const p1 = points[i];
                        
                        // Simple cubic bezier for smoothing
                        const cp1x = p0.x + (p1.x - p0.x) * 0.5;
                        const cp1y = p0.y;
                        const cp2x = p0.x + (p1.x - p0.x) * 0.5;
                        const cp2y = p1.y;
                        
                        path += ` C ${cp1x},${cp1y} ${cp2x},${cp2y} ${p1.x},${p1.y}`;
                    }
                    
                    return path;
                };
                
                // Dyno type label
                const dynoType = this.dynojetMode ? 'DYNOJET MODE' : 'MUSTANG DYNO (SIMULATED)';
                
                return `
                    <svg viewBox="0 0 ${width} ${height}" style="width: 100%; height: 100%; font-family: 'Orbitron', monospace;">
                        <!-- Background with gradient -->
                        <defs>
                            <linearGradient id="bgGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#0a0a0a;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1a1a1a;stop-opacity:1" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        
                        <!-- Background -->
                        <rect width="${width}" height="${height}" fill="url(#bgGradient)" />
                        <rect width="${width}" height="${height}" fill="url(#grid)" />
                        
                        <!-- Chart area background -->
                        <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" 
                              fill="#0a0a0a" stroke="rgba(251,191,36,0.2)" stroke-width="2" />
                        
                        <!-- Grid lines -->
                        <g stroke="rgba(255,255,255,0.05)" stroke-width="1">
                            <!-- Horizontal grid (10 lines) -->
                            ${Array.from({length: 11}, (_, i) => {
                                const y = padding.top + (chartHeight * i / 10);
                                return `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" />`;
                            }).join('')}
                            
                            <!-- Vertical grid (RPM) -->
                            ${(() => {
                                const lines = [];
                                for (let rpm = rpmMin; rpm <= rpmMax; rpm += 500) {
                                    const x = padding.left + ((rpm - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                    lines.push(`<line x1="${x}" y1="${padding.top}" x2="${x}" y2="${height - padding.bottom}" />`);
                                }
                                return lines.join('');
                            })()}
                        </g>
                        
                        <!-- Axes -->
                        <g stroke="rgba(251,191,36,0.3)" stroke-width="2" fill="none">
                            <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" />
                            <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" />
                            ${series.some(s => s.axis.startsWith('right')) ? 
                                `<line x1="${width - padding.right}" y1="${padding.top}" x2="${width - padding.right}" y2="${height - padding.bottom}" />` : ''}
                        </g>
                        
                        <!-- Zero line for slip -->
                        ${this.chartOptions.showSlip ? `
                            <line x1="${padding.left}" 
                                  y1="${height - padding.bottom - (50 / slipScale) * chartHeight}" 
                                  x2="${width - padding.right}" 
                                  y2="${height - padding.bottom - (50 / slipScale) * chartHeight}" 
                                  stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,5" opacity="0.5" />
                            <text x="${width - padding.right + 5}" 
                                  y="${height - padding.bottom - (50 / slipScale) * chartHeight + 4}" 
                                  text-anchor="start" font-size="10" fill="#f59e0b" opacity="0.7">0%</text>
                        ` : ''}
                        
                        <!-- Baseline curves (if available and not hidden) -->
                        ${baselineData && !this.hideBaseline ? `
                            <g fill="none" stroke-dasharray="8,4" opacity="0.6">
                                ${this.chartOptions.showPower ? (() => {
                                    const points = baselineData.map(d => {
                                        const x = padding.left + ((d.rpm - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                        const y = height - padding.bottom - (d.power / leftScale) * chartHeight;
                                        return { x, y: Math.max(padding.top, y) };
                                    });
                                    
                                    const maxPower = Math.max(...baselineData.map(d => d.power));
                                    const maxPowerPoint = baselineData.find(d => d.power === maxPower);
                                    const labelX = padding.left + ((maxPowerPoint.rpm - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                    const labelY = height - padding.bottom - (maxPower / leftScale) * chartHeight;
                                    
                                    return `
                                        <path d="${createSmoothPath(points)}" stroke="#22c55e" stroke-width="3" />
                                        <text x="${labelX}" y="${labelY - 10}" 
                                              fill="#22c55e" font-size="12" font-weight="600" text-anchor="middle">
                                            BASELINE ${Math.round(maxPower)} HP
                                        </text>
                                    `;
                                })() : ''}
                                
                                ${this.chartOptions.showTorque ? (() => {
                                    const points = baselineData.map(d => {
                                        const x = padding.left + ((d.rpm - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                        const y = height - padding.bottom - (d.torque / leftScale) * chartHeight;
                                        return { x, y: Math.max(padding.top, y) };
                                    });
                                    
                                    return `
                                        <path d="${createSmoothPath(points)}" stroke="#fb923c" stroke-width="3" />
                                    `;
                                })() : ''}
                                
                                ${this.chartOptions.showBoost ? (() => {
                                    const points = baselineData.map(d => {
                                        const x = padding.left + ((d.rpm - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                        const y = height - padding.bottom - (d.boost / boostScale) * chartHeight;
                                        return { x, y: Math.max(padding.top, y) };
                                    });
                                    
                                    return `
                                        <path d="${createSmoothPath(points)}" stroke="#0ea5e9" stroke-width="2" />
                                    `;
                                })() : ''}
                            </g>
                        ` : ''}
                        
                        <!-- Data curves with glow effect -->
                        <g fill="none">
                            ${series.map(s => {
                                const points = s.data.map(d => {
                                    const x = padding.left + ((d.x - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                    let y;
                                    
                                    if (s.axis === 'left') {
                                        y = height - padding.bottom - ((d.y - 0) / s.scale) * chartHeight;
                                    } else if (s.axis === 'right') {
                                        y = height - padding.bottom - ((d.y - 0) / s.scale) * chartHeight;
                                    } else if (s.axis === 'right2') {
                                        y = height - padding.bottom - ((d.y - 10) / 10) * chartHeight;
                                    } else if (s.axis === 'right3') {
                                        // Slip percentage - 0-100% scale
                                        y = height - padding.bottom - ((d.y - 0) / s.scale) * chartHeight;
                                    }
                                    
                                    return { x, y: Math.max(padding.top, Math.min(height - padding.bottom, y)) };
                                });
                                
                                const path = createSmoothPath(points);
                                
                                return `
                                    <path d="${path}" stroke="${s.color}" stroke-width="${s.strokeWidth}" 
                                          stroke-linejoin="round" stroke-linecap="round" filter="url(#glow)" opacity="0.8" />
                                    <path d="${path}" stroke="${s.color}" stroke-width="${s.strokeWidth}" 
                                          stroke-linejoin="round" stroke-linecap="round" />
                                `;
                            }).join('')}
                        </g>
                        
                        <!-- Peak value markers -->
                        ${series.map(s => {
                            const peak = Math.max(...s.data.map(d => d.y));
                            const peakPoint = s.data.find(d => d.y === peak);
                            if (!peakPoint) return '';
                            
                            const x = padding.left + ((peakPoint.x - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                            let y;
                            
                            if (s.axis === 'left') {
                                y = height - padding.bottom - ((peak - 0) / s.scale) * chartHeight;
                            } else if (s.axis === 'right') {
                                y = height - padding.bottom - ((peak - 0) / s.scale) * chartHeight;
                            } else if (s.axis === 'right2') {
                                y = height - padding.bottom - ((peak - 10) / 10) * chartHeight;
                            } else if (s.axis === 'right3') {
                                y = height - padding.bottom - ((peak - 0) / s.scale) * chartHeight;
                            }
                            
                            return `
                                <circle cx="${x}" cy="${y}" r="6" fill="${s.color}" stroke="#0a0a0a" stroke-width="2" />
                                <text x="${x}" y="${y - 10}" text-anchor="middle" fill="${s.color}" font-size="12" font-weight="600">
                                    ${Math.round(peak)}
                                </text>
                            `;
                        }).join('')}
                        
                        <!-- Axis Labels -->
                        <g fill="var(--platinum)" font-weight="600">
                            <!-- X-axis labels -->
                            <g font-size="14" fill="var(--silver)">
                                ${(() => {
                                    const labels = [];
                                    for (let rpm = rpmMin; rpm <= rpmMax; rpm += 500) {
                                        const x = padding.left + ((rpm - rpmMin) / (rpmMax - rpmMin)) * chartWidth;
                                        labels.push(`<text x="${x}" y="${height - padding.bottom + 30}" text-anchor="middle">${rpm}</text>`);
                                    }
                                    return labels.join('');
                                })()}
                                <text x="${width / 2}" y="${height - 30}" text-anchor="middle" font-size="18" 
                                      fill="var(--championship-gold)" letter-spacing="2">ENGINE SPEED (RPM)</text>
                            </g>
                            
                            <!-- Left Y-axis labels -->
                            ${series.some(s => s.axis === 'left') ? `
                                <g font-size="14" fill="var(--silver)">
                                    ${Array.from({length: 11}, (_, i) => {
                                        const value = leftScale * (10 - i) / 10;
                                        const y = padding.top + (chartHeight * i / 10);
                                        return `<text x="${padding.left - 20}" y="${y + 5}" text-anchor="end">${Math.round(value)}</text>`;
                                    }).join('')}
                                    <text x="40" y="${height / 2}" text-anchor="middle" font-size="18" 
                                          transform="rotate(-90 40 ${height / 2})" fill="var(--championship-gold)" 
                                          letter-spacing="2">POWER / TORQUE</text>
                                </g>
                            ` : ''}
                            
                            <!-- Right Y-axis labels for Boost -->
                            ${series.some(s => s.axis === 'right') ? `
                                <g font-size="14" fill="${series.find(s => s.axis === 'right').color}">
                                    ${Array.from({length: Math.ceil(boostScale / 5) + 1}, (_, i) => {
                                        const value = i * 5;
                                        const y = height - padding.bottom - (value / boostScale) * chartHeight;
                                        return `<text x="${width - padding.right + 20}" y="${y + 5}" text-anchor="start">${value}</text>`;
                                    }).join('')}
                                    <text x="${width - 40}" y="${height / 2}" text-anchor="middle" font-size="18" 
                                          transform="rotate(90 ${width - 40} ${height / 2})" letter-spacing="2">BOOST (PSI)</text>
                                </g>
                            ` : ''}
                            
                            <!-- Slip axis labels if shown (0-100%) -->
                            ${series.some(s => s.axis === 'right3') ? `
                                <g font-size="12" fill="#f59e0b">
                                    ${[0, 20, 40, 60, 80, 100].map(value => {
                                        const y = height - padding.bottom - (value / slipScale) * chartHeight;
                                        return `<text x="${width - padding.right + 60}" y="${y + 4}" text-anchor="start">${value}%</text>`;
                                    }).join('')}
                                </g>
                            ` : ''}
                        </g>
                        
                        <!-- Title and info -->
                        <text x="${width / 2}" y="40" text-anchor="middle" font-family="Michroma, sans-serif" 
                              font-size="28" fill="var(--platinum)" letter-spacing="3">
                            RPM-BASED VIRTUAL DYNO
                        </text>
                        
                        <!-- Vehicle info -->
                        <text x="${width / 2}" y="65" text-anchor="middle" font-size="14" fill="var(--silver)" letter-spacing="1">
                            ${GEAR_RATIOS[this.config.vehicle]?.name || this.config.vehicle} | 
                            ${this.config.modLevel.toUpperCase()} | 
                            ${this.config.fuel.toUpperCase()} | 
                            GEAR ${this.config.selectedGear} | 
                            ${dynoType}
                        </text>
                        
                        <!-- Legend box -->
                        <g transform="translate(${padding.left + 20}, ${padding.top + 20})">
                            <rect x="0" y="0" width="320" height="${30 + series.length * 30}" 
                                  fill="rgba(10,10,10,0.8)" stroke="rgba(251,191,36,0.2)" stroke-width="1" rx="10" />
                            
                            ${series.map((s, i) => {
                                const peak = Math.max(...s.data.map(d => d.y));
                                const peakRPM = s.data.find(d => d.y === peak)?.x || 0;
                                return `
                                    <g transform="translate(15, ${20 + i * 30})">
                                        <line x1="0" y1="0" x2="30" y2="0" stroke="${s.color}" stroke-width="4" />
                                        <text x="40" y="4" fill="${s.color}" font-size="14" font-weight="700">
                                            ${s.name}: ${Math.round(peak)} ${s.unit}
                                        </text>
                                        <text x="180" y="4" fill="var(--silver)" font-size="12">
                                            @ ${Math.round(peakRPM)} RPM
                                        </text>
                                    </g>
                                `;
                            }).join('')}
                        </g>
                        
                        <!-- Watermark -->
                        <text x="${width - 20}" y="${height - 10}" text-anchor="end" font-size="10" 
                              fill="var(--silver)" opacity="0.5" letter-spacing="1">
                            M-TUNED PERFORMANCE ENGINEERING
                        </text>
                    </svg>
                `;
            }
            
            downloadReport() {
                if (!this.analysisData || !this.analysisData.powerCurve) {
                    alert('No analysis data available');
                    return;
                }
                
                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = 1400;
                canvas.height = 900;
                const ctx = canvas.getContext('2d');
                
                // Background gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#0a0a0a');
                gradient.addColorStop(1, '#1a1a1a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Border with gradient
                const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                borderGradient.addColorStop(0, '#dc2626');
                borderGradient.addColorStop(0.5, '#fbbf24');
                borderGradient.addColorStop(1, '#dc2626');
                ctx.strokeStyle = borderGradient;
                ctx.lineWidth = 3;
                ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
                
                // Header
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('M-TUNED VIRTUAL DYNO', canvas.width / 2, 70);
                
                ctx.fillStyle = '#e5e5e5';
                ctx.font = '18px Arial';
                ctx.fillText(new Date().toLocaleString(), canvas.width / 2, 100);
                
                const vehicleName = GEAR_RATIOS[this.config.vehicle]?.name || this.config.vehicle;
                const dynoType = this.dynojetMode ? 'DYNOJET' : 'MUSTANG DYNO';
                ctx.fillText(`${vehicleName} | ${this.config.modLevel.toUpperCase()} | ${this.config.fuel.toUpperCase()} | ${dynoType}`, 
                    canvas.width / 2, 125);
                
                // Chart area
                const chartX = 120;
                const chartY = 180;
                const chartWidth = 1160;
                const chartHeight = 550;
                
                // Chart background
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(chartX, chartY, chartWidth, chartHeight);
                
                // Grid
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                
                // Draw grid
                for (let i = 0; i <= 10; i++) {
                    const x = chartX + (chartWidth * i / 10);
                    const y = chartY + (chartHeight * i / 10);
                    
                    ctx.beginPath();
                    ctx.moveTo(x, chartY);
                    ctx.lineTo(x, chartY + chartHeight);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(chartX, y);
                    ctx.lineTo(chartX + chartWidth, y);
                    ctx.stroke();
                }
                
                // Data
                const data = this.analysisData.powerCurve;
                const maxPower = Math.max(...data.map(d => d.power));
                const maxTorque = Math.max(...data.map(d => d.torque));
                const scale = Math.ceil(Math.max(maxPower, maxTorque) / 50) * 50;
                
                // Power curve
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 4;
                ctx.beginPath();
                
                data.forEach((point, i) => {
                    const x = chartX + ((point.rpm - 2000) / 5000) * chartWidth;
                    const y = chartY + chartHeight - (point.power / scale) * chartHeight;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                
                // Torque curve
                ctx.strokeStyle = '#fb923c';
                ctx.beginPath();
                
                data.forEach((point, i) => {
                    const x = chartX + ((point.rpm - 2000) / 5000) * chartWidth;
                    const y = chartY + chartHeight - (point.torque / scale) * chartHeight;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                
                // Peak values box
                const peakPower = Math.round(maxPower);
                const peakTorque = Math.round(maxTorque);
                const peakPowerRPM = data.find(d => d.power === maxPower)?.rpm || 0;
                const peakTorqueRPM = data.find(d => d.torque === maxTorque)?.rpm || 0;
                
                // Box background
                const boxGradient = ctx.createLinearGradient(chartX + 30, chartY + 30, chartX + 330, chartY + 150);
                boxGradient.addColorStop(0, 'rgba(251, 191, 36, 0.1)');
                boxGradient.addColorStop(1, 'rgba(220, 38, 38, 0.1)');
                ctx.fillStyle = boxGradient;
                ctx.fillRect(chartX + 30, chartY + 30, 300, 120);
                
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.strokeRect(chartX + 30, chartY + 30, 300, 120);
                
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('PEAK PERFORMANCE', chartX + 40, chartY + 60);
                
                ctx.font = '18px Arial';
                ctx.fillStyle = '#22c55e';
                ctx.fillText(`Power: ${peakPower} HP @ ${Math.round(peakPowerRPM)} RPM`, chartX + 40, chartY + 90);
                
                ctx.fillStyle = '#fb923c';
                ctx.fillText(`Torque: ${peakTorque} TQ @ ${Math.round(peakTorqueRPM)} RPM`, chartX + 40, chartY + 115);
                
                // SAE Correction info
                if (this.config.saeEnabled) {
                    const cf = new PowerCalculator(this.config).calculateSAECorrection();
                    ctx.fillStyle = '#0ea5e9';
                    ctx.font = '14px Arial';
                    ctx.fillText(`SAE Correction: ${cf.toFixed(3)} @ ${this.config.ambientTemp}°F`, chartX + 40, chartY + 140);
                }
                
                // Slip warning if detected
                const avgSlip = data.reduce((sum, p) => sum + Math.abs(p.slip || 0), 0) / data.length;
                if (avgSlip > 2) {
                    ctx.fillStyle = '#f59e0b';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(`⚠ Clutch slip detected: ${avgSlip.toFixed(1)}%`, chartX + chartWidth - 250, chartY + 50);
                }
                
                // Axis labels
                ctx.fillStyle = '#e5e5e5';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                
                // X-axis
                for (let rpm = 2000; rpm <= 7000; rpm += 500) {
                    const x = chartX + ((rpm - 2000) / 5000) * chartWidth;
                    ctx.fillText(rpm.toString(), x, chartY + chartHeight + 25);
                }
                
                ctx.font = 'bold 16px Arial';
                ctx.fillText('ENGINE SPEED (RPM)', chartX + chartWidth / 2, chartY + chartHeight + 50);
                
                // Y-axis
                ctx.textAlign = 'right';
                ctx.font = '14px Arial';
                for (let i = 0; i <= 10; i++) {
                    const value = scale * (10 - i) / 10;
                    const y = chartY + (chartHeight * i / 10);
                    ctx.fillText(Math.round(value).toString(), chartX - 10, y + 5);
                }
                
                // Legend
                ctx.fillStyle = '#22c55e';
                ctx.fillRect(chartX + chartWidth - 180, chartY + 30, 30, 4);
                ctx.fillStyle = '#e5e5e5';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Power (HP)', chartX + chartWidth - 140, chartY + 35);
                
                ctx.fillStyle = '#fb923c';
                ctx.fillRect(chartX + chartWidth - 180, chartY + 55, 30, 4);
                ctx.fillStyle = '#e5e5e5';
                ctx.fillText('Torque (TQ)', chartX + chartWidth - 140, chartY + 60);
                
                // Footer
                ctx.font = 'italic 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#a3a3a3';
                ctx.fillText('M-TUNED Performance Engineering | RPM-Based Virtual Dyno System', canvas.width / 2, canvas.height - 40);
                
                // Download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `MTUNED_VirtualDyno_${new Date().toISOString().slice(0,10)}.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                }, 'image/jpeg', 0.95);
            }
        }
        
        // Initialize application
        const app = new TuneAnalyzer();
        // Make it available globally for the request baseline button
        window.tuneAnalyzer = app;
    </script>
</body>
</html>